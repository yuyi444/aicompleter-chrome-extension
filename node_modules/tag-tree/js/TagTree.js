"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _liveSet = _interopRequireDefault(require("live-set"));

var _TagTreeNode2 = _interopRequireDefault(require("./TagTreeNode"));

var EMPTY_ARRAY = Object.freeze([]);

var TagTree =
/*#__PURE__*/
function (_TagTreeNode) {
  (0, _inherits2.default)(TagTree, _TagTreeNode);

  function TagTree(init) {
    var _this;

    (0, _classCallCheck2.default)(this, TagTree);
    var rootNodeController;
    _this = (0, _possibleConstructorReturn2.default)(this, (0, _getPrototypeOf2.default)(TagTree).call(this, {
      value: init.root,
      parent: null,
      ownedTags: new Set(init.tags.map(function (_ref) {
        var tag = _ref.tag;
        return tag;
      })),
      executor: function executor(controller) {
        rootNodeController = controller;
      }
    }));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "_nodeControllers", new Map());
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "_lookupTable", void 0);
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "_allByTag", void 0);
    if (!rootNodeController) throw new Error();

    _this._nodeControllers.set((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), rootNodeController);

    _this._lookupTable = new Map([[init.root, [(0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this))]]]);
    _this._allByTag = new Map();
    init.tags.forEach(function (_ref2) {
      var tag = _ref2.tag;

      var _LiveSet$active = _liveSet.default.active(),
          liveSet = _LiveSet$active.liveSet,
          controller = _LiveSet$active.controller;

      if (_this._allByTag.has(tag)) throw new Error('Tag specified twice: ' + tag);

      _this._allByTag.set(tag, {
        ownedTags: new Set(),
        liveSet: liveSet,
        controller: controller
      });
    });
    init.tags.forEach(function (_ref3) {
      var tag = _ref3.tag,
          ownedBy = _ref3.ownedBy;
      if (!ownedBy) return;
      ownedBy.forEach(function (owningTag) {
        var entry = _this._allByTag.get(owningTag);

        if (!entry) throw new Error("unknown ownedBy value for ".concat(tag, ": ").concat(owningTag));
        entry.ownedTags.add(tag);
      });
    });
    var controller = {
      tree: (0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)),
      addTaggedValue: function addTaggedValue(parent, tag, value) {
        var tagEntry = _this._allByTag.get(tag);

        if (!tagEntry) throw new Error("unknown tag: ".concat(tag));
        var controller;
        var node = new _TagTreeNode2.default({
          value: value,
          parent: parent,
          ownedTags: tagEntry.ownedTags,
          executor: function executor(_controller) {
            controller = _controller;
          }
        });
        if (!controller) throw new Error();

        _this._nodeControllers.set(node, controller);

        tagEntry.controller.add(node);

        var valueNodes = _this._lookupTable.get(value);

        if (valueNodes) {
          valueNodes.push(node);
        } else {
          _this._lookupTable.set(value, [node]);
        }

        var parentController = _this._nodeControllers.get(parent);

        if (!parentController) throw new Error('parent is not part of TagTree');
        parentController.addOwnedNode(tag, node);
        return node;
      },
      removeTaggedNode: function removeTaggedNode(parent, tag, node) {
        var tagEntry = _this._allByTag.get(tag);

        if (!tagEntry) throw new Error("unknown tag: ".concat(tag));

        var parentController = _this._nodeControllers.get(parent);

        if (!parentController) throw new Error('parent is not part of TagTree');
        var value = node.getValue();

        var nodes = _this._lookupTable.get(value);

        if (!nodes) throw new Error('node was missing from lookup table before removal');

        if (nodes.length > 1) {
          var ix = nodes.indexOf(node);
          if (ix < 0) throw new Error('node was missing from list in lookup table before removal');
          nodes.splice(ix, 1);
        } else {
          _this._lookupTable.delete(value);
        }

        node.getOwned().forEach(function (liveSet, tag) {
          liveSet.values().forEach(function (childNode) {
            controller.removeTaggedNode(node, tag, childNode);
          });
        });
        tagEntry.controller.remove(node);
        parentController.removeOwnedNode(tag, node);

        _this._nodeControllers.delete(node);
      },
      end: function end() {
        _this._nodeControllers.forEach(function (controller) {
          controller.end();
        });

        _this._allByTag.forEach(function (_ref4) {
          var controller = _ref4.controller;
          controller.end();
        });
      }
    };
    init.executor(controller);

    init.executor = function () {}; // release reference


    return _this;
  }

  (0, _createClass2.default)(TagTree, [{
    key: "getNodesForValue",
    value: function getNodesForValue(value) {
      var l = this._lookupTable.get(value);

      return l ? Object.freeze(l.slice()) : EMPTY_ARRAY;
    }
  }, {
    key: "getAllByTag",
    value: function getAllByTag(tag) {
      var entry = this._allByTag.get(tag);

      if (!entry) throw new Error("tag does not exist in TagTree: ".concat(tag));
      return entry.liveSet;
    }
  }, {
    key: "getAll",
    value: function getAll() {
      var m = new Map();

      this._allByTag.forEach(function (_ref5, tag) {
        var liveSet = _ref5.liveSet;
        m.set(tag, liveSet);
      });

      return m;
    }
  }]);
  return TagTree;
}(_TagTreeNode2.default);

exports.default = TagTree;
module.exports = exports.default;
module.exports.default = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9UYWdUcmVlLmpzIl0sIm5hbWVzIjpbIkVNUFRZX0FSUkFZIiwiT2JqZWN0IiwiZnJlZXplIiwiVGFnVHJlZSIsImluaXQiLCJyb290Tm9kZUNvbnRyb2xsZXIiLCJ2YWx1ZSIsInJvb3QiLCJwYXJlbnQiLCJvd25lZFRhZ3MiLCJTZXQiLCJ0YWdzIiwibWFwIiwidGFnIiwiZXhlY3V0b3IiLCJjb250cm9sbGVyIiwiTWFwIiwiRXJyb3IiLCJfbm9kZUNvbnRyb2xsZXJzIiwic2V0IiwiX2xvb2t1cFRhYmxlIiwiX2FsbEJ5VGFnIiwiZm9yRWFjaCIsIkxpdmVTZXQiLCJhY3RpdmUiLCJsaXZlU2V0IiwiaGFzIiwib3duZWRCeSIsIm93bmluZ1RhZyIsImVudHJ5IiwiZ2V0IiwiYWRkIiwidHJlZSIsImFkZFRhZ2dlZFZhbHVlIiwidGFnRW50cnkiLCJub2RlIiwiVGFnVHJlZU5vZGUiLCJfY29udHJvbGxlciIsInZhbHVlTm9kZXMiLCJwdXNoIiwicGFyZW50Q29udHJvbGxlciIsImFkZE93bmVkTm9kZSIsInJlbW92ZVRhZ2dlZE5vZGUiLCJnZXRWYWx1ZSIsIm5vZGVzIiwibGVuZ3RoIiwiaXgiLCJpbmRleE9mIiwic3BsaWNlIiwiZGVsZXRlIiwiZ2V0T3duZWQiLCJ2YWx1ZXMiLCJjaGlsZE5vZGUiLCJyZW1vdmUiLCJyZW1vdmVPd25lZE5vZGUiLCJlbmQiLCJsIiwic2xpY2UiLCJtIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUVBOztBQUdBOztBQWdCQSxJQUFNQSxXQUFrQixHQUFHQyxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLENBQTNCOztJQUVxQkMsTzs7Ozs7QUFTbkIsbUJBQVlDLElBQVosRUFBa0M7QUFBQTs7QUFBQTtBQUNoQyxRQUFJQyxrQkFBSjtBQUNBLDZHQUFNO0FBQ0pDLE1BQUFBLEtBQUssRUFBRUYsSUFBSSxDQUFDRyxJQURSO0FBRUpDLE1BQUFBLE1BQU0sRUFBRSxJQUZKO0FBR0pD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LEdBQUYsQ0FBTU4sR0FBTixFQUFXWSxPQUFYO0FBQ0QsT0FGRDs7QUFHQSxhQUFPaUMsQ0FBUDtBQUNEOzs7RUFuSXFDdEIscUIiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBAZmxvdyAqL1xuXG5pbXBvcnQgTGl2ZVNldCBmcm9tICdsaXZlLXNldCc7XG5pbXBvcnQgdHlwZSB7TGl2ZVNldENvbnRyb2xsZXJ9IGZyb20gJ2xpdmUtc2V0JztcblxuaW1wb3J0IFRhZ1RyZWVOb2RlIGZyb20gJy4vVGFnVHJlZU5vZGUnO1xuaW1wb3J0IHR5cGUge1RhZ1RyZWVOb2RlQ29udHJvbGxlcn0gZnJvbSAnLi9UYWdUcmVlTm9kZSc7XG5cbmV4cG9ydCB0eXBlIFRhZ1RyZWVDb250cm9sbGVyPFQ+ID0ge1xuICB0cmVlOiBUYWdUcmVlPFQ+O1xuICBhZGRUYWdnZWRWYWx1ZShwYXJlbnQ6IFRhZ1RyZWVOb2RlPFQ+LCB0YWc6IHN0cmluZywgdmFsdWU6IFQpOiBUYWdUcmVlTm9kZTxUPjtcbiAgcmVtb3ZlVGFnZ2VkTm9kZShwYXJlbnQ6IFRhZ1RyZWVOb2RlPFQ+LCB0YWc6IHN0cmluZywgbm9kZTogVGFnVHJlZU5vZGU8VD4pOiB2b2lkO1xuICBlbmQoKTogdm9pZDtcbn07XG5cbmV4cG9ydCB0eXBlIFRhZ1RyZWVJbml0PFQ+ID0ge3xcbiAgcm9vdDogVDtcbiAgdGFnczogJFJlYWRPbmx5QXJyYXk8e3wgdGFnOiBzdHJpbmcsIG93bmVkQnk/OiA/JFJlYWRPbmx5QXJyYXk8c3RyaW5nPiB8fT47XG4gIGV4ZWN1dG9yOiAoY29udHJvbGxlcjogVGFnVHJlZUNvbnRyb2xsZXI8VD4pID0+IHZvaWQ7XG58fTtcblxuY29uc3QgRU1QVFlfQVJSQVk6IGFueVtdID0gT2JqZWN0LmZyZWV6ZShbXSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhZ1RyZWU8VD4gZXh0ZW5kcyBUYWdUcmVlTm9kZTxUPiB7XG4gIF9ub2RlQ29udHJvbGxlcnM6IE1hcDxUYWdUcmVlTm9kZTxUPiwgVGFnVHJlZU5vZGVDb250cm9sbGVyPFQ+PiA9IG5ldyBNYXAoKTtcbiAgX2xvb2t1cFRhYmxlOiBNYXA8VCwgQXJyYXk8VGFnVHJlZU5vZGU8VD4+PjtcbiAgX2FsbEJ5VGFnOiBNYXA8c3RyaW5nLCB7XG4gICAgb3duZWRUYWdzOiBTZXQ8c3RyaW5nPjtcbiAgICBsaXZlU2V0OiBMaXZlU2V0PFRhZ1RyZWVOb2RlPFQ+PjtcbiAgICBjb250cm9sbGVyOiBMaXZlU2V0Q29udHJvbGxlcjxUYWdUcmVlTm9kZTxUPj47XG4gIH0+O1xuXG4gIGNvbnN0cnVjdG9yKGluaXQ6IFRhZ1RyZWVJbml0PFQ+KSB7XG4gICAgbGV0IHJvb3ROb2RlQ29udHJvbGxlcjtcbiAgICBzdXBlcih7XG4gICAgICB2YWx1ZTogaW5pdC5yb290LFxuICAgICAgcGFyZW50OiBudWxsLFxuICAgICAgb3duZWRUYWdzOiBuZXcgU2V0KGluaXQudGFncy5tYXAoKHt0YWd9KSA9PiB0YWcpKSxcbiAgICAgIGV4ZWN1dG9yOiAoY29udHJvbGxlcikgPT4ge1xuICAgICAgICByb290Tm9kZUNvbnRyb2xsZXIgPSBjb250cm9sbGVyO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmICghcm9vdE5vZGVDb250cm9sbGVyKSB0aHJvdyBuZXcgRXJyb3IoKTtcbiAgICB0aGlzLl9ub2RlQ29udHJvbGxlcnMuc2V0KHRoaXMsIHJvb3ROb2RlQ29udHJvbGxlcik7XG5cbiAgICB0aGlzLl9sb29rdXBUYWJsZSA9IG5ldyBNYXAoW1tpbml0LnJvb3QsIFt0aGlzXV1dKTtcblxuICAgIHRoaXMuX2FsbEJ5VGFnID0gbmV3IE1hcCgpO1xuICAgIGluaXQudGFncy5mb3JFYWNoKCh7dGFnfSkgPT4ge1xuICAgICAgY29uc3Qge2xpdmVTZXQsIGNvbnRyb2xsZXJ9ID0gTGl2ZVNldC5hY3RpdmUoKTtcbiAgICAgIGlmICh0aGlzLl9hbGxCeVRhZy5oYXModGFnKSkgdGhyb3cgbmV3IEVycm9yKCdUYWcgc3BlY2lmaWVkIHR3aWNlOiAnK3RhZyk7XG4gICAgICB0aGlzLl9hbGxCeVRhZy5zZXQodGFnLCB7b3duZWRUYWdzOiBuZXcgU2V0KCksIGxpdmVTZXQsIGNvbnRyb2xsZXJ9KTtcbiAgICB9KTtcblxuICAgIGluaXQudGFncy5mb3JFYWNoKCh7dGFnLCBvd25lZEJ5fSkgPT4ge1xuICAgICAgaWYgKCFvd25lZEJ5KSByZXR1cm47XG4gICAgICBvd25lZEJ5LmZvckVhY2gob3duaW5nVGFnID0+IHtcbiAgICAgICAgY29uc3QgZW50cnkgPSB0aGlzLl9hbGxCeVRhZy5nZXQob3duaW5nVGFnKTtcbiAgICAgICAgaWYgKCFlbnRyeSkgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIG93bmVkQnkgdmFsdWUgZm9yICR7dGFnfTogJHtvd25pbmdUYWd9YCk7XG4gICAgICAgIGVudHJ5Lm93bmVkVGFncy5hZGQodGFnKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgY29uc3QgY29udHJvbGxlciA9IHtcbiAgICAgIHRyZWU6IHRoaXMsXG4gICAgICBhZGRUYWdnZWRWYWx1ZTogKHBhcmVudCwgdGFnLCB2YWx1ZSkgPT4ge1xuICAgICAgICBjb25zdCB0YWdFbnRyeSA9IHRoaXMuX2FsbEJ5VGFnLmdldCh0YWcpO1xuICAgICAgICBpZiAoIXRhZ0VudHJ5KSB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gdGFnOiAke3RhZ31gKTtcblxuICAgICAgICBsZXQgY29udHJvbGxlcjtcbiAgICAgICAgY29uc3Qgbm9kZSA9IG5ldyBUYWdUcmVlTm9kZSh7XG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgcGFyZW50LFxuICAgICAgICAgIG93bmVkVGFnczogdGFnRW50cnkub3duZWRUYWdzLFxuICAgICAgICAgIGV4ZWN1dG9yOiAoX2NvbnRyb2xsZXIpID0+IHtcbiAgICAgICAgICAgIGNvbnRyb2xsZXIgPSBfY29udHJvbGxlcjtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAoIWNvbnRyb2xsZXIpIHRocm93IG5ldyBFcnJvcigpO1xuICAgICAgICB0aGlzLl9ub2RlQ29udHJvbGxlcnMuc2V0KG5vZGUsIGNvbnRyb2xsZXIpO1xuXG4gICAgICAgIHRhZ0VudHJ5LmNvbnRyb2xsZXIuYWRkKG5vZGUpO1xuXG4gICAgICAgIGNvbnN0IHZhbHVlTm9kZXMgPSB0aGlzLl9sb29rdXBUYWJsZS5nZXQodmFsdWUpO1xuICAgICAgICBpZiAodmFsdWVOb2Rlcykge1xuICAgICAgICAgIHZhbHVlTm9kZXMucHVzaChub2RlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9sb29rdXBUYWJsZS5zZXQodmFsdWUsIFtub2RlXSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwYXJlbnRDb250cm9sbGVyID0gdGhpcy5fbm9kZUNvbnRyb2xsZXJzLmdldChwYXJlbnQpO1xuICAgICAgICBpZiAoIXBhcmVudENvbnRyb2xsZXIpIHRocm93IG5ldyBFcnJvcigncGFyZW50IGlzIG5vdCBwYXJ0IG9mIFRhZ1RyZWUnKTtcbiAgICAgICAgcGFyZW50Q29udHJvbGxlci5hZGRPd25lZE5vZGUodGFnLCBub2RlKTtcblxuICAgICAgICByZXR1cm4gbm9kZTtcbiAgICAgIH0sXG4gICAgICByZW1vdmVUYWdnZWROb2RlOiAocGFyZW50LCB0YWcsIG5vZGUpID0+IHtcbiAgICAgICAgY29uc3QgdGFnRW50cnkgPSB0aGlzLl9hbGxCeVRhZy5nZXQodGFnKTtcbiAgICAgICAgaWYgKCF0YWdFbnRyeSkgdGhyb3cgbmV3IEVycm9yKGB1bmtub3duIHRhZzogJHt0YWd9YCk7XG5cbiAgICAgICAgY29uc3QgcGFyZW50Q29udHJvbGxlciA9IHRoaXMuX25vZGVDb250cm9sbGVycy5nZXQocGFyZW50KTtcbiAgICAgICAgaWYgKCFwYXJlbnRDb250cm9sbGVyKSB0aHJvdyBuZXcgRXJyb3IoJ3BhcmVudCBpcyBub3QgcGFydCBvZiBUYWdUcmVlJyk7XG5cbiAgICAgICAgY29uc3QgdmFsdWUgPSBub2RlLmdldFZhbHVlKCk7XG4gICAgICAgIGNvbnN0IG5vZGVzID0gdGhpcy5fbG9va3VwVGFibGUuZ2V0KHZhbHVlKTtcbiAgICAgICAgaWYgKCFub2RlcykgdGhyb3cgbmV3IEVycm9yKCdub2RlIHdhcyBtaXNzaW5nIGZyb20gbG9va3VwIHRhYmxlIGJlZm9yZSByZW1vdmFsJyk7XG4gICAgICAgIGlmIChub2Rlcy5sZW5ndGggPiAxKSB7XG4gICAgICAgICAgY29uc3QgaXggPSBub2Rlcy5pbmRleE9mKG5vZGUpO1xuICAgICAgICAgIGlmIChpeCA8IDApIHRocm93IG5ldyBFcnJvcignbm9kZSB3YXMgbWlzc2luZyBmcm9tIGxpc3QgaW4gbG9va3VwIHRhYmxlIGJlZm9yZSByZW1vdmFsJyk7XG4gICAgICAgICAgbm9kZXMuc3BsaWNlKGl4LCAxKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl9sb29rdXBUYWJsZS5kZWxldGUodmFsdWUpO1xuICAgICAgICB9XG5cbiAgICAgICAgbm9kZS5nZXRPd25lZCgpLmZvckVhY2goKGxpdmVTZXQsIHRhZykgPT4ge1xuICAgICAgICAgIGxpdmVTZXQudmFsdWVzKCkuZm9yRWFjaChjaGlsZE5vZGUgPT4ge1xuICAgICAgICAgICAgY29udHJvbGxlci5yZW1vdmVUYWdnZWROb2RlKG5vZGUsIHRhZywgY2hpbGROb2RlKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGFnRW50cnkuY29udHJvbGxlci5yZW1vdmUobm9kZSk7XG4gICAgICAgIHBhcmVudENvbnRyb2xsZXIucmVtb3ZlT3duZWROb2RlKHRhZywgbm9kZSk7XG4gICAgICAgIHRoaXMuX25vZGVDb250cm9sbGVycy5kZWxldGUobm9kZSk7XG4gICAgICB9LFxuICAgICAgZW5kOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuX25vZGVDb250cm9sbGVycy5mb3JFYWNoKGNvbnRyb2xsZXIgPT4ge1xuICAgICAgICAgIGNvbnRyb2xsZXIuZW5kKCk7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLl9hbGxCeVRhZy5mb3JFYWNoKCh7Y29udHJvbGxlcn0pID0+IHtcbiAgICAgICAgICBjb250cm9sbGVyLmVuZCgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9O1xuICAgIGluaXQuZXhlY3V0b3IoY29udHJvbGxlcik7XG4gICAgaW5pdC5leGVjdXRvciA9ICgpID0+IHt9OyAvLyByZWxlYXNlIHJlZmVyZW5jZVxuICB9XG5cbiAgZ2V0Tm9kZXNGb3JWYWx1ZSh2YWx1ZTogVCk6ICRSZWFkT25seUFycmF5PFRhZ1RyZWVOb2RlPFQ+PiB7XG4gICAgY29uc3QgbCA9IHRoaXMuX2xvb2t1cFRhYmxlLmdldCh2YWx1ZSk7XG4gICAgcmV0dXJuIGwgPyBPYmplY3QuZnJlZXplKGwuc2xpY2UoKSkgOiBFTVBUWV9BUlJBWTtcbiAgfVxuXG4gIGdldEFsbEJ5VGFnKHRhZzogc3RyaW5nKTogTGl2ZVNldDxUYWdUcmVlTm9kZTxUPj4ge1xuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5fYWxsQnlUYWcuZ2V0KHRhZyk7XG4gICAgaWYgKCFlbnRyeSkgdGhyb3cgbmV3IEVycm9yKGB0YWcgZG9lcyBub3QgZXhpc3QgaW4gVGFnVHJlZTogJHt0YWd9YCk7XG4gICAgcmV0dXJuIGVudHJ5LmxpdmVTZXQ7XG4gIH1cblxuICBnZXRBbGwoKTogTWFwPHN0cmluZywgTGl2ZVNldDxUYWdUcmVlTm9kZTxUPj4+IHtcbiAgICBjb25zdCBtID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX2FsbEJ5VGFnLmZvckVhY2goKHtsaXZlU2V0fSwgdGFnKSA9PiB7XG4gICAgICBtLnNldCh0YWcsIGxpdmVTZXQpO1xuICAgIH0pO1xuICAgIHJldHVybiBtO1xuICB9XG59XG4iXX0=